<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Info</title>
   <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f9;
    }

    .container, .container2{
      max-width: 800px;
      margin: 0 auto;
      background:#3b240b;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .container2 {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    padding-top: 0px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header img {
      width: 250px;
      height: 250px;
      border-radius: 8px;
      object-fit: cover;
    }

    .header .info {
      flex: 1;
    }

    .header .info h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #ffffff;
    }

    .header .info p {
      margin: 5px 0;
      font-size: 1rem;
      color: #ffffff;
    }

    .content {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    /* background: crimson; */
    gap: 20px;
    }

    .content .section {
    width: 48%;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    }

    .content .section h2 {
      font-size: 1.2rem;
      color: #333;
      margin-bottom: 10px;
    }

    .content .section ul {
      list-style-type: none;
      padding-left: 0;
      color: #555;
    }

    .content .section ul li {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .content .section ul li.checked {
      background-color: #d4edda; /* Green background for checked items */
      color: #155724;
    }

    .content .section ul li input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
      cursor: pointer;
      accent-color: #28a745; /* Green checkbox */
    }

   .buttons {
  display: flex;
  justify-content: center;
  gap: 104px;
  margin-top: 32px;
}

.buttons button {
  padding: 12px 36px;
  font-size: 1.1rem;
  border: none;
  border-radius: 24px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: background 0.2s, color 0.2s, transform 0.15s;
}

.buttons .back-button {
  background: #fdd835;
  color: #333;
}

.buttons .back-button:hover {
  background: #fbc02d;
  color: #000;
  transform: scale(1.07);
}

.buttons .okay-button {
  background: #ecd8a7;
  color: #000000;
}

.buttons .okay-button:hover {
  background: #388e3c;
  color: #fff;
  transform: scale(1.07);
}
    .speech-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    cursor: pointer;
    transition: transform 0.2s ease;
    background: white;
    padding: 10px;
    border-radius: 10px;
    }

    .speech-icon.enabled {
      transform: scale(1.2);
    }

    .speech-indicator {
    position: absolute;
    top: 80px;
    right: 20px;
    font-size: 0.9rem;
    color: #fff;
    text-align: center;
    width: 70px;
    padding-top: 20px;
    }


.background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1; /* Ensure it stays behind everything */
  overflow: hidden;
}

/* Style the background image */
.bg-img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  min-width: 100%;
  min-height: 100%;
  object-fit: cover;
  object-position: center;
  display: block;
  z-index: -1;
}

  </style>
</head>
<body>
<div class="background">
    <img src="images/brickwall.jpg" class="bg-img" alt="Cafe Background" />
  </div>

</div>
  <div class="container">
    <img src="speech.png" alt="Speech Icon" class="speech-icon" id="speechIcon" />
    <div class="speech-indicator" id="speechIndicator">Disabled</div>
    <div class="header">
      <img id="food-image" src="" alt="Food Image">
      <div class="info">
        <h1 id="food-name">Loading...</h1>
        <!-- Servings control with arrows -->
        <div style="color:#fff;font-size:1rem;margin-top:8px;display:flex;align-items:center;gap:8px;">
          Servings:
          <button id="servings-decrease" type="button" style="margin-left:8px;padding:2px 10px;font-size:1.2rem;border-radius:50%;border:none;background:#ecd8a7;cursor:pointer;">&#8592;</button>
          <input id="servings-input" type="number" min="1" max="20" value="4" style="width:48px;text-align:center;font-size:1rem;border-radius:6px;border:1px solid #ccc;" />
          <button id="servings-increase" type="button" style="padding:2px 10px;font-size:1.2rem;border-radius:50%;border:none;background:#ecd8a7;cursor:pointer;">&#8594;</button>
        </div>
        <p id="food-budget">Estimated budget: Loading...</p>
        <p id="food-filters">Filters included: Loading...</p>
        <p id="food-allergens" style="margin:5px 0;font-size:1rem;color:#ffffff;">Allergens: Loading...</p>
        <div id="food-link" style="margin-top:8px;color: white;"></div>
      </div>
    </div>
    <div id="food-description" style="margin: 18px 0px 0px;
    font-size: 0.9rem;
    color: rgb(5 0 0);
    background: #fff;
    border-radius: 6px;
    padding: 14px 18px;">
      <strong>Description:</strong>
      <span id="food-description-text"></span>
    </div>
    <div id="food-history" style="margin: 18px 0px 0px;
    font-size: 0.9rem;
    color: rgb(5 0 0);
    background: #fff;
    border-radius: 6px;
    padding: 14px 18px;
    display: none;">
      <strong>History:</strong>
      <span id="food-history-text"></span>
    </div>
    <!--add the history here -->
    </div>
   <div class=" container2">
    <div class="content" id="detailsContent" style="display:none;">
      <div class="section">
        <h2>Ingredients:</h2>
        <ul id="food-ingredients">
          <!-- Ingredients will be dynamically populated -->
        </ul>
      </div>
      <div class="section">
        <h2>Instructions:</h2>
        <ul id="food-instructions">
          <!-- Instructions will be dynamically populated -->
        </ul>
      </div>
      </div>
<div class="buttons">
  <button class="back-button" onclick="window.location.href='../listofgames.html'">
    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">stadia_controller</span>
    Back
  </button>
  <button class="okay-button" onclick="window.location.href='../index.html'">
    <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">house</span>
    Okay
  </button>
</div>
    </div>
 

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCA2KS4aKwM5P4_et3wifB4sRg23tvaK04",
      authDomain: "dish-4be2b.firebaseapp.com",
      projectId: "dish-4be2b",
      storageBucket: "dish-4be2b.appspot.com",
      messagingSenderId: "479066048512",
      appId: "1:479066048512:web:7489944044adddc4c570e5",
      measurementId: "G-8D2QSMQWT2",
      databaseURL: "https://dish-4be2b-default-rtdb.firebaseio.com",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get the food name from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const foodName = urlParams.get("food");
    console.log(`Fetching details for food: ${foodName}`);

    // Fetch food details from Firebase
    async function fetchFoodDetails(foodName) {
      const snapshot = await get(ref(db, `recipes`));
      if (snapshot.exists()) {
        const recipes = snapshot.val();
        for (const category in recipes) {
          for (const key in recipes[category]) {
            const recipe = recipes[category][key];
            if (recipe.name.toLowerCase() === foodName.toLowerCase()) {
              // Attach the found category to the recipe object
              recipe._category = category;
              return recipe;
            }
          }
        }
      }
      return null;
    }

    // --- YouTube API KEY (replace with your own) ---
    const YOUTUBE_API_KEY = "AIzaSyAbRGZ3nQA2ANEpqSWZO3mmQeyt34AWDqA";

    // Extract YouTube video ID from a URL
    function extractYouTubeVideoId(url) {
      const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
      const match = url.match(regExp);
      return match ? match[1] : null;
    }

    // Fetch YouTube video title using API
    async function fetchYouTubeTitle(videoId) {
      if (!videoId || YOUTUBE_API_KEY === "YOUR_YOUTUBE_API_KEY") return null;
      try {
        const apiUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`;
        const response = await fetch(apiUrl);
        const data = await response.json();
        if (data.items && data.items.length > 0) {
          return data.items[0].snippet.title;
        }
      } catch (e) {
        console.error("Failed to fetch YouTube title:", e);
      }
      return null;
    }

    // Get a nice label for non-YouTube links
    function getLinkLabel(url) {
      try {
        const u = new URL(url);
        // Try to use the hostname, or fallback to "Visit Link"
        if (u.hostname.includes("mcdo") || u.hostname.includes("mcdonald")) {
          return "McDonald's Delivery";
        }
        if (u.hostname.includes("jollibee")) {
          return "Jollibee Delivery";
        }
        if (u.hostname.includes("kfc")) {
          return "KFC Delivery";
        }
        // Otherwise, show the hostname
        return u.hostname.replace("www.", "");
      } catch {
        return "Visit Link";
      }
    }

    let currentFoodDetails = null;
    let defaultServings = 4; // Default servings per recipe

    // Utility: Convert a fraction string to a float (e.g., "1/2" => 0.5, "2 1/2" => 2.5)
function parseFraction(str) {
  str = str.trim();
  // Match "2 1/2", "1/2", "2"
  const mixed = str.match(/^(\d+)\s+(\d+)\/(\d+)$/);
  if (mixed) {
    return parseInt(mixed[1]) + parseInt(mixed[2]) / parseInt(mixed[3]);
  }
  const frac = str.match(/^(\d+)\/(\d+)$/);
  if (frac) {
    return parseInt(frac[1]) / parseInt(frac[2]);
  }
  const num = str.match(/^\d+(\.\d+)?$/);
  if (num) {
    return parseFloat(str);
  }
  return null;
}

// Utility: Scale ingredient string (e.g., "2 cups rice" or "1/2 cup rice") by a factor
function scaleIngredient(ingredient, scale) {
  // Match leading quantity (supports "2 1/2", "1/2", "2")
  const match = ingredient.match(/^((\d+\s+\d+\/\d+)|(\d+\/\d+)|(\d+(\.\d+)?))(\s*)(.*)$/);
  if (match) {
    const qtyStr = match[1];
    const rest = match[7];
    const qty = parseFraction(qtyStr);
    if (qty !== null) {
      // Round to 2 decimal places, remove trailing .00
      let scaled = (qty * scale).toFixed(2).replace(/\.00$/, "");
      return `${scaled} ${rest}`;
    }
  }
  return ingredient; // No number to scale
}

    // Update UI for servings
    function updateServingsUI(servings) {
      if (!currentFoodDetails) return;
      const scale = servings / defaultServings;
      // Update budget
      const budget = currentFoodDetails.budget || 0;
      document.getElementById("food-budget").textContent =
        `Estimated budget: ₱${Math.round(budget * scale)}`;
      // Update ingredients
      if (currentFoodDetails._category === "home") {
        const ingredientsList = document.getElementById("food-ingredients");
        ingredientsList.innerHTML = "";
        (currentFoodDetails.ingredients || []).forEach(ingredient => {
          const li = document.createElement("li");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.addEventListener("change", () => {
            li.classList.toggle("checked", checkbox.checked);
          });
          li.appendChild(checkbox);
          li.appendChild(document.createTextNode(scaleIngredient(ingredient, scale)));
          ingredientsList.appendChild(li);
        });
      }
    }

    // Display food details
    async function displayFoodDetails() {
      const foodDetails = await fetchFoodDetails(foodName);
      currentFoodDetails = foodDetails;
      // Set default servings (from DB or fallback to 4)
      defaultServings = (foodDetails && foodDetails.servings) ? Number(foodDetails.servings) : 4;
      document.getElementById("servings-input").value = defaultServings;

      if (foodDetails) {
        document.getElementById("food-name").textContent = foodDetails.name;
        document.getElementById("food-budget").textContent = `Estimated budget: ₱${foodDetails.budget || "N/A"}`;
        document.getElementById("food-filters").textContent = `Filters included: ${foodDetails.filters || "none"}`;
        document.getElementById("food-allergens").textContent = `Allergens: ${foodDetails.allergens || "none"}`;
        if (foodDetails.image) {
          document.getElementById("food-image").src = foodDetails.image;
        }

        // Show description if available
        const descDiv = document.getElementById("food-description");
        const descText = document.getElementById("food-description-text");
        if (foodDetails.description && foodDetails.description.trim() !== "") {
          descText.textContent = " " + foodDetails.description;
          descDiv.style.display = "";
        } else {
          descText.textContent = "";
          descDiv.style.display = "none";
        }

        // Show history if available
        const historyDiv = document.getElementById("food-history");
        const historyText = document.getElementById("food-history-text");
        if (foodDetails.history && foodDetails.history.trim() !== "") {
          historyText.textContent = " " + foodDetails.history;
          historyDiv.style.display = "";
        } else {
          historyText.textContent = "";
          historyDiv.style.display = "none";
        }

        // Show link if available, with YouTube title if possible, otherwise use a smart label
        const foodLinkDiv = document.getElementById("food-link");
        if (foodDetails.link && foodDetails.link.trim() !== "") {
          const videoId = extractYouTubeVideoId(foodDetails.link);
          if (videoId) {
            foodLinkDiv.textContent = "Link: Loading...";
            const title = await fetchYouTubeTitle(videoId);
            foodLinkDiv.innerHTML = `Link: <a href="${foodDetails.link}" target="_blank" style="color:#1976d2;text-decoration:underline;font-weight:bold;">${title || "YouTube Video"}</a>`;
          } else {
            // Not a YouTube link, use smart label
            const label = getLinkLabel(foodDetails.link);
            foodLinkDiv.innerHTML = `Link: <a href="${foodDetails.link}" target="_blank" style="color:#1976d2;text-decoration:underline;font-weight:bold;">${label}</a>`;
          }
        } else {
          foodLinkDiv.innerHTML = "";
        }

        // Show or hide ingredients/instructions based on category
        const detailsContent = document.getElementById("detailsContent");
        if (foodDetails._category === "home") {
          detailsContent.style.display = "";
          const ingredientsList = document.getElementById("food-ingredients");
          ingredientsList.innerHTML = "";
          (foodDetails.ingredients || []).forEach(ingredient => {
            const li = document.createElement("li");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.addEventListener("change", () => {
              li.classList.toggle("checked", checkbox.checked);
            });
            li.appendChild(checkbox);
            li.appendChild(document.createTextNode(ingredient));
            ingredientsList.appendChild(li);
          });

          const instructionsList = document.getElementById("food-instructions");
          instructionsList.innerHTML = "";
          (foodDetails.instructions || []).forEach(instruction => {
            const li = document.createElement("li");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.addEventListener("change", () => {
              li.classList.toggle("checked", checkbox.checked);
            });
            li.appendChild(checkbox);
            li.appendChild(document.createTextNode(instruction));
            instructionsList.appendChild(li);
          });
        } else {
          detailsContent.style.display = "none";
        }
      } else {
        document.getElementById("food-name").textContent = "Food not found";
        document.getElementById("food-budget").textContent = "";
        document.getElementById("food-filters").textContent = "";
        document.getElementById("detailsContent").style.display = "none";
        document.getElementById("food-link").innerHTML = "";
        document.getElementById("food-description-text").textContent = "";
        document.getElementById("food-description").style.display = "none";
        document.getElementById("food-history-text").textContent = "";
        document.getElementById("food-history").style.display = "none";
        document.getElementById("food-allergens").textContent = "";
      }

      // After rendering, update for current servings
      updateServingsUI(Number(document.getElementById("servings-input").value));
    }

    // Listen for servings change (arrows and input)
    document.addEventListener("DOMContentLoaded", () => {
      const servingsInput = document.getElementById("servings-input");
      const decreaseBtn = document.getElementById("servings-decrease");
      const increaseBtn = document.getElementById("servings-increase");

      function clamp(val, min, max) {
        return Math.max(min, Math.min(max, val));
      }

      decreaseBtn.addEventListener("click", () => {
        let val = parseInt(servingsInput.value) || 1;
        val = clamp(val - 1, 1, 20);
        servingsInput.value = val;
        updateServingsUI(val);
      });

      increaseBtn.addEventListener("click", () => {
        let val = parseInt(servingsInput.value) || 1;
        val = clamp(val + 1, 1, 20);
        servingsInput.value = val;
        updateServingsUI(val);
      });

      servingsInput.addEventListener("input", () => {
        let val = parseInt(servingsInput.value) || 1;
        val = clamp(val, 1, 20);
        servingsInput.value = val;
        updateServingsUI(val);
      });
    });

    displayFoodDetails();

    // Speech API functionality
    const speechIcon = document.getElementById("speechIcon");
    const speechIndicator = document.getElementById("speechIndicator");
    let speechEnabled = false;
    let recognition;

    // Initialize Speech Recognition
    if ("webkitSpeechRecognition" in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-US";

      recognition.onstart = () => {
        console.log("Speech recognition started");
        speechIndicator.textContent = "Listening...";
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim().toLowerCase();
        console.log("Heard:", transcript);

        if (transcript === "tell me the instructions.") {
          const instructions = Array.from(document.querySelectorAll("#food-instructions li"))
            .map(li => li.textContent.trim())
            .join(", ");
          if (instructions) {
            const utterance = new SpeechSynthesisUtterance(`The instructions are: ${instructions}`);
            speechIndicator.textContent = "Speaking...";
            speechSynthesis.speak(utterance);
            utterance.onend = () => {
              speechIndicator.textContent = "Enabled";
            };
          } else {
            const utterance = new SpeechSynthesisUtterance("No instructions available.");
            speechIndicator.textContent = "Speaking...";
            speechSynthesis.speak(utterance);
            utterance.onend = () => {
              speechIndicator.textContent = "Enabled";
            };
          }
        } else {
          console.log("Unrecognized command:", transcript);
          speechIndicator.textContent = "Enabled";
        }
      };

      recognition.onerror = (event) => {
        console.error("Speech recognition error:", event.error);
        speechIndicator.textContent = "Error";
      };

      recognition.onend = () => {
        console.log("Speech recognition ended.");
        if (speechEnabled) {
          speechIndicator.textContent = "Enabled";
        }
      };
    } else {
      console.error("Web Speech API is not supported in this browser.");
      speechIndicator.textContent = "Not Supported";
    }

    // Toggle speech recognition
    speechIcon.addEventListener("click", () => {
      speechEnabled = !speechEnabled;
      if (speechEnabled) {
        speechIcon.classList.add("enabled");
        console.log("speech enabled");
        speechIndicator.textContent = "Enabled";

        if (recognition) {
          recognition.start();
        } else {
          alert("Speech recognition is not supported in this browser.");
        }
      } else {
        speechIcon.classList.remove("enabled");
        console.log("speech disabled");
        speechIndicator.textContent = "Disabled";

        if (recognition) {
          recognition.stop();
        }
      }
    });
  </script>
</body>
</html>